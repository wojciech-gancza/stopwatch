<html>

<head>
  <style>
	table {
		border-collapse: collapse;
	}    
	td {
		padding: 3pt;
		margin: 0pt;
	}
    .task_time {
        text-align: right;
	    font-family: Courier New;
	    font-size: 12pt;
    }
    .task_name {
	    font-family: Verdana;
	    font-size: 12pt;
	    text-decoration: none;
	    color: white;
    }
	.head_checkbox {
		background: #c0c0c0;
		color: black;
	    width: 28px;
	}
	.head {
		background: #c0c0c0;
		color: black;
	    font-family: Verdana;
	    font-size: 12pt;
	    text-decoration: none;
		font-weight: bold;
	}
    .head_time {
		background: #c0c0c0;
		color: black;
		text-align: right;
		font-family: Courier New;
		font-size: 12pt;
		font-weight: bold;
    }
  </style>
</head>

<body style="margin: 0; padding: 0">
  <form name="stopwatch">
    <div style="position: absolute; width: 100%; height: 100%;">
      <div id="page" style="position: relative; margin-left: auto; margin-right: auto; margin-top: 40px; padding: 6pt; background: gray; width: 480px; height: 320; text-color: light-gray;">&nbsp;</div>
    </div>
	<script>

function convertToTimeText(seconds) {
	if (seconds < 0) 
		return "Negative";
	if (seconds < 60)
		return (seconds < 10 ? "0" : "") + seconds.toString();
	else if (seconds < 60*60)
		return convertToTimeText(Math.floor(seconds/60)) + ":" + convertToTimeText(seconds%60);
	else if (seconds < 60*60*24)
		return convertToTimeText(Math.floor(seconds/(60*60))) + ":" + convertToTimeText(seconds%(60*60));
	else
		return (Math.floor(seconds/(24*60*60))).toString() + "d " + convertToTimeText(seconds%(24*60*60));
};

function attr_class(class_name) {
	if (class_name)
		return ' class="' + class_name.toString() + '"';
	else
		return "";
}

function tag_table(table_body) {
	return "<table width=\"100%\">" + table_body + "</table>";
}

function tag_tr(row_body) {
	return "<tr>" + row_body + "</tr>";
}

function tag_td(cell_class, cell_body) {
	return "<td" + attr_class(cell_class) + ">" + cell_body + "</td>";
}

function tag_radio(value, selected) {
	return '<input type="radio" name="task" value="' + value + 
			'" onClick="javascript: selectTaskByRadio(' + 
			value + ');"' + (selected ? " checked>" : ">"); 
}

function tag_checkbox(selected) {
	return '<input type="checkbox" name="running" onClick="javascript: changeRunningCheckbox();"' + 
			(selected ? " checked>" : ">"); 
}

function tag_a_selection(cell_class, value, body) {
	return '<a href="javascript: selectTaskByLink(' + value + ');"' + 
			attr_class(cell_class) + '>' + body + '</a>';
}

function tag_span(id, content) {
	return '<span id="time' + id.toString() + '">' + content + '</span>';
}

function selectTaskByRadio(task_number) {
	updateStoredTime();
	current = task_number;
	startCountingTime();
	current_task = task_number;
	storeData();
}

function selectTaskByLink(task_number) {
	document.forms.stopwatch.task.value = task_number;
	selectTaskByRadio(task_number)
}

function changeRunningCheckbox() {
	updateStoredTime();
	is_running = document.forms.stopwatch.running.checked
	startCountingTime();
	storeData();
}

function startCountingTime() {
	from_time = getCurrentTimeAsSec();
	storeData();
}

function setPageContent(page) {
	document.getElementById("page").innerHTML = page;
}

function updateTime(id, value) {
	document.getElementById("time"+id.toString()).innerHTML = convertToTimeText(value);
}

function getCurrentTimeAsSec() {
	now = new Date();
	now_as_seconds = now.getTime() / 1000;
	return Math.floor(now_as_seconds);
}

function getNewTime() {
	return unstored_time = getCurrentTimeAsSec() - from_time;
}

function timeTick() {
	if (is_running) {
		unstored_time = getNewTime();
		total_time = getTotalTime()
		updateTime("all", total_time + unstored_time);
		updateTime(current_task, task_list[current_task].stored_time + unstored_time);
	}
}

function updateStoredTime() {
	if (is_running) {
		task_list[current_task].stored_time = task_list[current_task].stored_time + getNewTime()
	}
}

function getTotalTime() {
	total_time = 0;
	for (i=0; i<task_list.length; ++i) {
		total_time = total_time + task_list[i].stored_time;
	};
	return total_time;	
}

function storeData() {
	data = {"task_list": task_list,  
	         "app_data": { 
				"is_running": is_running,
				"from_time": from_time, 
				"current_task": current_task
				}
		    };
	txt = JSON.stringify(data)
	
	// alert(txt);
}

function loadData(init) {

	init = '{"task_list":[{"name":"Working","stored_time":0},{"name":"Sleeping","stored_time":11},{"name":"Meeting","stored_time":0},{"name":"Just thinking","stored_time":179}],"app_data":{"is_running":true,"from_time":1670625171,"current_task":1}}';
	
	data = JSON.parse(init);
	is_running = data.app_data.is_running;
	from_time = data.app_data.from_time;
	current_task = data.app_data.current_task
	task_list = data.task_list
	updateStoredTime();
	from_time = getCurrentTimeAsSec();
};


var is_running = false;
var from_time = 0;
var current_task = 0;
var task_list = [ ];

loadData();

table = "";
table = tag_tr(
	tag_td("head_checkbox", tag_checkbox(is_running)) +
	tag_td("head", "worktime") + 
	tag_td("head_time", tag_span('all', convertToTimeText(getTotalTime()))));
	
for (i=0; i<task_list.length; ++i) {
	row = tag_td("", tag_radio(i.toString(), (i == current_task)));
	row = row + tag_td("", tag_a_selection("task_name", i.toString(), task_list[i].name));
	row = row + tag_td("task_time", tag_span(i, convertToTimeText(task_list[i].stored_time)));
	table = table + tag_tr(row);
};

page = tag_table(table);
setPageContent(page)

window.setInterval(timeTick, 1000);

		</script>
    </form>
</body>

</html>